@page "/login"
<PageTitle>Anmeldung</PageTitle>

@using AbiWebsite.Data
@using AbiWebsite.Models
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Diagnostics

@inject AbiDbContext Db
@inject ProtectedSessionStorage Session
@inject IHttpContextAccessor HttpContextAccessor
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

<h3 class="mb-5">Anmeldung</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert alert-danger">@Message</div>
}

<EditForm Model="nameModel" OnValidSubmit="CheckName" FormName="namecheck">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-3">
        <label class="form-label">Vollständiger Name (Vor- und Nachname)</label>
        <InputText class="form-control bg-dark text-white" @bind-Value="nameModel.FullName" />
    </div>
    <button type="submit" class="btn btn-primary">Weiter</button>
</EditForm>

@code {
    private string? Message;

    [SupplyParameterFromForm(FormName = "namecheck")]
    private NameModel nameModel { get; set; } = new();
    public class NameModel
    {
        [Required(ErrorMessage = "Name kann nicht leer sein.")]
        public string FullName { get; set; } = "";
    }

    private async Task CheckName()
    {
        var name = nameModel.FullName?.Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            Message = "Bitte gib deinen vollständigen Namen ein.";
            return;
        }
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length < 2) {
            Message = "Bitte gib sowohl Vor- als auch Nachname ein.";
            return;
        }
        var existingStudent = await Db.Students.FirstOrDefaultAsync(s => s.FullName.ToLower() == name.ToLower());
        if (existingStudent != null) {
            Navigation.NavigateTo("/loginwithcode?name=" + Uri.EscapeDataString(name));
        } else {
            Navigation.NavigateTo("/register?name=" + Uri.EscapeDataString(name));
        }
    }
}

