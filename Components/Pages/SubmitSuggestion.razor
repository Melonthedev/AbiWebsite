@page "/submitmotto"
@attribute [Authorize]
@attribute [IgnoreAntiforgeryToken]
<PageTitle>Motto Vorschlagen</PageTitle>

@using AbiWebsite.Data
@using AbiWebsite.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Mvc

@inject AbiDbContext Db
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<h3>Abi-Motto Einreichen</h3>

@if (Message != null)
{
    <div class="alert @MessageClass">@Message</div>
}

<EditForm Model="newSuggestion" OnValidSubmit="HandleValidSubmit" FormName="suggestionform">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="title" class="form-label">Motto</label>
        <InputText id="title" class="form-control bg-dark text-white" @bind-Value="newSuggestion.Title" />
    </div>

    <button type="submit" class="btn btn-primary">Absenden</button>
</EditForm>

@code {
    private string? Message = "Dein Vorschlag sollte am Besten aus einem kurzen, prägnanten Hauptspruch und einer Ergänzung/Erklärung bestehen";
    private string MessageClass = "alert-info";

    [SupplyParameterFromForm(FormName = "suggestionform")]
    public MottoSuggestion newSuggestion { get; set; } = new();

    private int? currentStudentId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst("StudentId");
            if (idClaim != null && int.TryParse(idClaim.Value, out var id))
            {
                currentStudentId = id;
            }
        }
    }


    private async Task HandleValidSubmit()
    {
        if (string.IsNullOrWhiteSpace(newSuggestion.Title) ||
            newSuggestion.Title.Length < 5 || newSuggestion.Title.Length > 50)
        {
            Message = "❌ Dein Motto muss zwischen 5 und 50 Zeichen lang sein.";
            MessageClass = "alert-danger";
            return;
        }

        if (currentStudentId == null) {
            Navigation.NavigateTo("/login");
            return;
        }

        newSuggestion.StudentId = currentStudentId.Value;
        Db.MottoSuggestions.Add(newSuggestion);
        await Db.SaveChangesAsync();

        Message = "✅ Motto erfolgreich eingereicht!";
        MessageClass = "alert-success";

        newSuggestion = new MottoSuggestion();
    }
}
